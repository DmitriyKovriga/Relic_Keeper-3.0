Техническая архитектура и функциональный анализ сеточных систем инвентаря и складов в современных ARPG Эволюция игровых интерфейсов в жанре Action Role-Playing Games (ARPG) привела к формированию уникальной парадигмы управления ресурсами, известной как сеточный инвентарь или «Inventory Tetris». Эта система, популяризированная серией Diablo и доведенная до технологического совершенства в Path of Exile (PoE), представляет собой не просто визуальное отображение предметов, а сложную симуляцию физического пространства, где каждый предмет обладает геометрическими размерами и весом, выраженным в занимаемых ячейках. 1 Для разработчика, стремящегося реализовать подобную систему, критически важно понимать, что за внешней простотой перетаскивания иконок скрывается многослойная архитектура, включающая математические преобразования координат, транзакционные модели обмена данными между клиентом и сервером, а также изощренные алгоритмы валидации пространственной логики. 3 Архитектура модели данных и выбор структур хранения Фундаментом любого надежного инвентаря является строгое разделение логики (Data Model) и представления (View). В Path of Exile и аналогичных системах инвентарь не является просто набором UI-элементов; это массив данных, который существует на сервере и зеркалируется на клиенте. 6 Двумерные массивы против разреженных структур При проектировании сетки размером (например, стандартные 12x5 в PoE или 12x12 в базовой вкладке склада) перед инженером встает вопрос выбора структуры данных для хранения информации об оккупации ячеек. 8 Структура данных Эффективность доступа Особенности реализации Применимость Двумерный массив (Item[,]) Хранит ссылки на объекты предметов или null. Прост в реализации коллизий. 10 Оптимально для фиксированных сеток инвентаря. Одномерный массив с индексацией Использует формулу для доступа. Кэш-дружелюбен. 11 Рекомендуется для высокопроизводительных систем. Словарь (Dictionary&lt;Vector2Int, Item&gt;) (амортизированное) Эффективен для огромных, потенциально бесконечных или разреженных складов. 13 Вкладки склада с тысячами мелких предметов. Битовая карта (Bitmask) Используется для сверхбыстрой проверки «занято/свободно» без обращения к объектам. 3 Оптимизация алгоритмов авто-сортировки. Технический анализ показывает, что Path of Exile использует комбинацию этих подходов. Предметы хранятся как уникальные сущности с метаданными (ID, свойства, редкость), а сетка инвентаря представляет собой карту ссылок. Если предмет занимает 2x4 ячейки, то в логической сетке все 8 соответствующих ячеек содержат указатель на один и тот же уникальный экземпляр предмета. 3 Это позволяет мгновенно определить, какой предмет находится под курсором, вне зависимости от того, в какую часть его иконки кликнул игрок. Предмет как пространственный объект В коде предмет определяется не только своими характеристиками, но и пространственным вектором. В простейшей реализации структура данных предмета включает: Инстанс-ID: Глобально уникальный идентификатор. Dimensions (Size): Вектор (например, 1x1 для колец, 2x3 для луков). 3 Root Position: Координаты левого верхнего угла в сетке . Rotation State: Булево значение (Portrait/Landscape), влияющее на замену и при расчетах. 17 Сложность возникает при реализации предметов сложной формы (L-образные или Т-образные), которые встречаются в таких играх, как Backpack Hero, но Path of Exile придерживается строгих прямоугольников для упрощения вычислительной сложности и предсказуемости для игрока. 19 Пространственная логика и расчет координат курсора Ключевым фактором «легкости» управления, о которой запрашивает пользователь, является бесшовное преобразование экранных координат мыши в ячейки сетки. Математика захвата и «Grab Offset» Когда игрок инициирует событие OnBeginDrag, система должна зафиксировать не только сам предмет, но и относительное смещение курсора от его «корня» (левого верхнего угла). Это критически важная деталь: без учета grabOffset иконка предмета при захвате мгновенно «прыгнет», центрируясь на мыши, что разрушает тактильное ощущение. 21 Расчет локального смещения в пикселях: Во время перемещения визуальная позиция иконки, следующей за курсором, вычисляется как: Для логической привязки к сетке используется обратное преобразование. Если — размер одной ячейки в пикселях, а — позиция верхнего левого угла окна инвентаря, то потенциальная ячейка сброса вычисляется через нормализацию: Использование функций округления (floor/round) позволяет системе «понимать», в какие слоты игрок пытается вставить предмет еще до того, как кнопка мыши будет отпущена. 24 Это дает возможность отрисовывать «призрачную» подложку (ghost preview), которая подсвечивает целевые ячейки зеленым или красным цветом. 23 Валидация площади и предотвращение коллизий Перед подтверждением вставки (Drop) система выполняет итерационную проверку целевой области. Для предмета размером , начинающегося в ячейке , алгоритм должен проверить каждое значение в диапазоне: Если хотя бы одна ячейка выходит за границы массива ( ) или уже занята другим предметом, флаг валидности сбрасывается. 3 Механика обмена предметами (Swap) и интеллектуальные алгоритмы Приоритетным требованием является легкость свапа. В Path of Exile реализован алгоритм «Swap if One», который значительно повышает удобство менеджмента. 7 Алгоритм «Swap if One» В отличие от простых систем, где для установки предмета А нужно сначала вручную убрать предмет Б, продвинутый инвентарь анализирует содержимое целевой области. Если область занята ровно одним уникальным предметом, система разрешает установку, автоматически «выбивая» старый предмет на курсор. 16 Логика проверки: Собрать все уникальные ссылки на предметы в целевой области в HashSet. Если HashSet.Count == 0, область свободна — обычная вставка. Если HashSet.Count == 1, в области находится один предмет — выполнить Swap. Если HashSet.Count &gt; 1, область перекрывает несколько разных предметов — блокировать действие. 16 Эта механика позволяет игроку быстро перекладывать экипировку. Например, при наведении большого двуручного меча (2x4) на уже экипированный или лежащий в сумке меч того же размера, происходит мгновенная замена. Однако, если меч перекрывает щит и шлем одновременно, свап не сработает, так как система не знает, какой из двух предметов следует заменить. 16 Динамическая переориентация и автозаполнение Хотя в Path of Exile 2 игроки до сих пор просят функцию авто-сортировки, технически она реализуется как вариация задачи о упаковке контейнеров (Bin Packing Problem), которая является NP-полной. 11 Для реализации «легкого» переноса в своей игре разработчику следует использовать жадный алгоритм First-Fit Decreasing: Отсортировать предметы по убыванию площади ( ). Для каждого предмета найти первую свободную ячейку, начиная с , двигаясь по рядам, а затем по столбцам. Если предмет не влезает, попробовать его повернуть на 90 градусов и повторить поиск. 32 Взаимодействие инвентаря и склада (Stash) Окно инвентаря (Inventory) и окно склада (Stash) в PoE — это два независимых контейнера, которые «уживаются» вместе через общую систему транзакций и событий. 8 Синхронизация и транзакционная модель Когда оба окна открыты, они подписываются на глобальные события изменений в модели данных игрока. Важнейшей функцией здесь является Ctrl + Left Click — быстрый перенос предмета между контейнерами без использования курсора. 8 Техническая цепочка переноса: Запрос: Клиент инициирует MoveRequest(ItemID, SourceContainer, DestinationContainer). Поиск места: Складской менеджер (StashManager) вызывает функцию FindFirstEmptySlot(item.Size) в целевой вкладке. Валидация: Проверка прав доступа (не является ли вкладка «только для чтения», как в случае с завершившимися лигами). 36 Атомарная операция: Предмет удаляется из массива А и вставляется в массив Б. Сервер отправляет подтверждение TransferSuccess. UI Update: Оба окна перерисовывают свои сетки на основе обновленных данных. 8 Вкладки склада и специализированные контейнеры В Path of Exile склад представлен массивом вкладок, каждая из которых может иметь свой тип сетки. 8 Тип вкладки Конфигурация сетки Специальные функции Обычная 12x12 (144 слота) Хранит любые предметы. 8 Quad Tab 24x24 (576 слотов) В 4 раза плотнее, требует уменьшения иконок. 8 Валютная Слоты под ID предметов Стакание до 5000 единиц, игнорирует геометрию. 36 Карты/Waystones Иерархическая структура Хранение по тирам и регионам. 8 Интересным техническим решением является «Affinities» (Сродство). Это система тегов, где каждой вкладке склада можно назначить определенные типы предметов (например, «Валюта» или «Карты»). При Ctrl+Click на предмет в инвентаре, система сначала опрашивает все вкладки на наличие соответствующего тега, и если находит, переносит предмет туда, даже если эта вкладка сейчас не открыта. 8 Это избавляет игрока от необходимости вручную переключать вкладки при разгрузке после рейдов. Реализация переноса предмета «в курсоре» Перенос предмета «в курсоре» (Carried State) — это состояние, при котором объект временно исключается из всех контейнеров и привязывается к контроллеру ввода. Состояния предмета Stored: Находится в сетке, имеет RootPosition. Carried: Находится «в руке», RootPosition не определен, следует за мышью. 7 Ghost: Визуальная проекция предмета на сетку во время переноса. 23 Если игрок закроет окно инвентаря, удерживая предмет, система должна иметь стратегию разрешения конфликта. В Diablo 2 предмет оставался «прилипшим» к курсору даже при закрытых окнах. В Path of Exile при попытке закрыть инвентарь с предметом в руке или при выходе из игры предмет может быть автоматически сброшен на землю или возвращен в ближайший свободный слот, чтобы предотвратить потерю данных или эксплойты с «лишним» слотом. 29 План разработки функциональности для собственной игры Для реализации системы, минимально отличающейся от Path of Exile, рекомендуется следующий план действий, разделенный на модули. Этап 1: Модель данных и базовая сетка Создать класс GridContainer, хранящий Item[,] contents. Реализовать метод bool CanPlace(Item item, int x, int y), включающий проверку границ и пересечений. Реализовать метод Item GetItemAt(int x, int y), который возвращает ссылку на предмет, занимающий данную ячейку. Этап 2: Визуализация и ввод Создать InventoryUI, который динамически генерирует SlotUI элементы (визуальные ячейки). Реализовать DraggableItemUI, который подписывается на события мыши. Внедрить расчет grabOffset для плавности захвата. Этап 3: Механика Swap Модернизировать метод сброса предмета. Если CanPlace возвращает ложь, вызвать GetUniqueItemsInArea(targetRect). Если найден ровно один предмет, запустить процедуру Swap(heldItem, existingItem). Этап 4: Система склада и вкладки Создать StashManager, управляющий списком GridContainer. Реализовать систему переключения вкладок через UI-табы. Внедрить систему «Affinities» (словарик ItemType -&gt; TabID). Этап 5: Оптимизация UX Добавить визуальный «призрак» предмета при наведении. Реализовать подсветку ячеек: зеленая (свободно), желтая (свап), красная (занято/нет места). Добавить поддержку Ctrl + Click для моментального перемещения между открытыми контейнерами. Промпт для Cursor AI (для планирования и воплощения) Для достижения технически точного результата в Cursor AI, используйте следующий структурированный запрос: Master Prompt: Grid-Based Inventory System with &quot;Swap if One&quot; Logic &quot;Разработай на модульную систему сеточного инвентаря и склада в стиле Path of Exile. Архитектура должна строго разделять данные и визуальную часть. Технические требования: Структура данных: Реализуй класс InventoryItem (ID, ширина, высота, иконка) и класс InventoryGrid (двумерный массив ссылок на предметы). Если предмет занимает больше 1 ячейки, все ячейки в массиве должны хранить ссылку на этот предмет. Математика координат: Реализуй плавный захват предмета с учетом grabOffset (смещение клика относительно верхнего левого угла иконки). Добавь функцию конвертации координат мыши в индекс ячейки сетки с проверкой границ. Приоритетная механика Swap: При попытке сброса предмета в занятую область, реализуй алгоритм: если в целевой области находится ровно один уникальный предмет (одинаковые ссылки во всех ячейках области), этот предмет должен автоматически 'выбиться' на курсор, а новый предмет — встать на его место. Если предметов в области несколько, действие блокируется. Система склада: Создай StashManager, поддерживающий несколько вкладок (экземпляров InventoryGrid). Реализуй логику Ctrl + Click, которая ищет первый свободный прямоугольный слот в текущей открытой вкладке склада или инвентаря и автоматически перемещает предмет. Визуальная обратная связь: Добавь отрисовку 'призрака' предмета (ghost preview) под курсором, подсвечивающего ячейки, которые будут заняты при сбросе. Цель: Максимальная плавность перемещения и легкость в сортировке через Swap. Код должен быть чистым, с комментариями на русском языке и готовым к расширению (например, для добавления авто-сортировки в будущем).&quot; Глубинный анализ и Ripple Effects (Вторые и третьи порядки) Внедрение жесткой сеточной системы влечет за собой ряд последствий для геймдизайна, которые необходимо учитывать на этапе планирования. Влияние на игровой цикл (Game Loop) Ограниченный инвентарь с предметами разного размера заставляет игрока постоянно оценивать ценность предмета на единицу занимаемой площади (Value per Slot). 15 Это создает естественные паузы в экшене («Town Portal» циклы), которые в Path of Exile используются для эмоциональной разрядки после напряженного боя и взаимодействия с экономикой игры (торговля, крафт). 42 Если сделать инвентарь слишком легким или бесконечным, ценность отдельного дропа нивелируется, и игра превращается в симулятор пылесоса. Экономические последствия и монетизация В Path of Exile система складов является основным источником дохода для разработчиков. Продажа специализированных вкладок (валютных, карточных) — это продажа комфорта, а не силы (Power). 8 Техническая реализация должна поддерживать «Remove-only» вкладки, которые появляются при слиянии лиг: это позволяет избежать удаления предметов игрока при превышении лимита купленного пространства, сохраняя целостность базы данных. 36 Контроллерная парадигма и доступность Перенос сеточного инвентаря на консоли (Xbox/PS5) — одна из сложнейших задач. В Path of Exile 2 разработчики внедрили «процедурную навигацию»: курсор прыгает не по пикселям, а по центрам предметов. 27 При нажатии вправо система сканирует сетку в поисках следующего валидного ID предмета в этом направлении. Ваша техническая реализация должна изначально поддерживать такую возможность, не полагаясь исключительно на координаты мыши. 27 Заключение и выводы Создание инвентаря в стиле Path of Exile — это задача не столько графическая, сколько алгоритмическая. Ключ к успеху лежит в трех компонентах: Математическая точность: Идеальный расчет grabOffset и привязки к сетке создают ощущение «премиальности» интерфейса. 45 Транзакционность: Каждое движение предмета — это микро-сделка, которая должна быть подтверждена сервером для предотвращения дублирования предметов. 6 Интеллектуальный Swap: Возможность быстро менять предметы местами без промежуточных действий является критическим требованием для современного игрока, привыкшего к высокой динамике ARPG. 16 Реализация системы складов с поддержкой «сродства» (Affinities) и специализированных вкладок позволит вашей игре не только эффективно управлять огромными массивами данных, но и создаст глубокий, затягивающий мета-геймплей, который станет неотъемлемой частью удовольствия от прогрессии персонажа. 8 Works cited Inventory Systems in Games - Lost in the Grid, accessed on February 10, 2026, https://outof.games/news/6699-inventory-systems-in-games-lost-in-the-grid/ RPG/Survival Inventory - Why Grids? : r/gamedesign - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/gamedesign/comments/1hwqe8y/rpgsurvival_inventory_why_grids/ [Help] Trying to put together a diablo-styled inventory : r/unrealengine - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/unrealengine/comments/8g4mjo/help_trying_to_put_together_a_diablostyled/ What approach would you use to implement a diablo-like inventory system in SDL2?, accessed on February 10, 2026, https://www.reddit.com/r/gamedev/comments/1jm9ehp/what_approach_would_you_use_to_implement_a/ Building a Robust Grid-Based Inventory System in Unity - Wayline, accessed on February 10, 2026, https://www.wayline.io/blog/unity-grid-inventory-system Player Inventory Synchronization - Modder Support - Minecraft Forge Forums, accessed on February 10, 2026, https://forums.minecraftforge.net/topic/27248-player-inventory-synchronization/ c# - How to structure a complex inventory system in Unity?, accessed on February 10, 2026, https://gamedev.stackexchange.com/questions/211432/how-to-structure-a-complex-inventory-system-in-unity Path of Exile Stash Tabs Explained - Maxroll.gg, accessed on February 10, 2026, https://maxroll.gg/poe/getting-started/stash-tabs-explained Game mechanics - Path of Exile Wiki - Fandom, accessed on February 10, 2026, https://pathofexile.fandom.com/wiki/Game_mechanics 2d array vs dict - Ask - GameDev.tv, accessed on February 10, 2026, https://community.gamedev.tv/t/2d-array-vs-dict/220070 2D sort for inventory items? - Game Development Stack Exchange, accessed on February 10, 2026, https://gamedev.stackexchange.com/questions/58716/2d-sort-for-inventory-items Is it more efficient to store my tile grid as a dictionary or an array?, accessed on February 10, 2026, https://gamedev.stackexchange.com/questions/60433/is-it-more-efficient-to-store-my-tile-grid-as-a-dictionary-or-an-array Arrays vs dictionaries : r/twinegames - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/twinegames/comments/1h2dc7s/arrays_vs_dictionaries/ When to use dictionaries vs arrays? (in terms of performance) : r/Julia - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/Julia/comments/1d1s5kg/when_to_use_dictionaries_vs_arrays_in_terms_of/ Escape from Tarkov: Smart Inventory Management Guide - Eye On Annapolis, accessed on February 10, 2026, https://www.eyeonannapolis.net/2025/10/escape-from-tarkov-smart-inventory-management-guide/ Inventory System | Let's make a Grid Based Inventory System, accessed on February 10, 2026, https://inventory.captaincoder.org/ How to Make Grid-Based Inventory - Tunguska Development Blog, accessed on February 10, 2026, https://warzonegameblog.wordpress.com/2016/08/10/how-to-make-grid-based-inventory/ Grid Inventory System with Custom Patterns for Godot 4 - GitHub, accessed on February 10, 2026, https://github.com/alpapaydin/Godot-4-Grid-Inventory-with-Patterns The logic of how to make a simple diablo style inventory system? : r/gamemaker - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/gamemaker/comments/1pexvps/the_logic_of_how_to_make_a_simple_diablo_style/ Complex inventory system : r/Unity3D - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/Unity3D/comments/13fkspm/complex_inventory_system/ Custom drag ghost in react: The way that actually works | by Nazmul Hasan Shajib | Medium, accessed on February 10, 2026, https://medium.com/@shojib116/custom-drag-ghost-in-react-the-way-that-actually-works-c802e4ec7128 Subnautica/Diablo Style Inventory | by Nocturnal Wisp - Medium, accessed on February 10, 2026, https://medium.com/@NocturnalWisp/subnautica-diablo-style-inventory-38d2f7551b5a Trying out a grid inventory system : r/godot - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/godot/comments/s6fiij/trying_out_a_grid_inventory_system/ Getting location of mouse on a grid - Stack Overflow, accessed on February 10, 2026, https://stackoverflow.com/questions/36790693/getting-location-of-mouse-on-a-grid Finding the closest grid coordinate to the mouse position with javascript/jQuery, accessed on February 10, 2026, https://stackoverflow.com/questions/2712744/finding-the-closest-grid-coordinate-to-the-mouse-position-with-javascript-jquery Item Shape Inventory Grid - Opsive, accessed on February 10, 2026, https://opsive.com/support/documentation/ultimate-inventory-system/ui/item-view-slots-container/inventorygrid/item-shape-inventory-grid/ After multiple failed attempts, I finally made an inventory that uses different sizes for items! : r/Unity3D - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/Unity3D/comments/8j15x4/after_multiple_failed_attempts_i_finally_made_an/ How to Make Multi Slot Grid Inventory with Rotating Items in Godot 4+ - YouTube, accessed on February 10, 2026, https://www.youtube.com/watch?v=ByL17d28x9Q Stash/Inventory: Too Many Items - Forum - Path of Exile, accessed on February 10, 2026, https://www.pathofexile.com/forum/view-thread/20528 How can I properly and efficiently preform a Sized Item Grid Based Sort? - Stack Overflow, accessed on February 10, 2026, https://stackoverflow.com/questions/29626520/how-can-i-properly-and-efficiently-preform-a-sized-item-grid-based-sort How to manage grid-based inventory with items larger than 1x1 cell?, accessed on February 10, 2026, https://gamedev.stackexchange.com/questions/72237/how-to-manage-grid-based-inventory-with-items-larger-than-1x1-cell Operating System - First Fit Algorithm - TutorialsPoint, accessed on February 10, 2026, https://www.tutorialspoint.com/operating_system/os_first_fit_algorithm.htm First-Fit Allocation in Operating Systems - GeeksforGeeks, accessed on February 10, 2026, https://www.geeksforgeeks.org/operating-systems/first-fit-allocation-in-operating-systems/ algorithm - Auto-organized / smart inventory system? - Game Development Stack Exchange, accessed on February 10, 2026, https://gamedev.stackexchange.com/questions/58161/auto-organized-smart-inventory-system Early Access Discussion - Inventory Organisation - Forum - Path of Exile, accessed on February 10, 2026, https://www.pathofexile.com/forum/view-thread/3688703 Stash - Path of Exile Wiki - Fandom, accessed on February 10, 2026, https://pathofexile.fandom.com/wiki/Stash Stash - PoE Wiki, accessed on February 10, 2026, https://www.poewiki.net/wiki/Stash Item Transfer - Can we get improvements? : r/pathofexile - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/pathofexile/comments/fkpz53/item_transfer_can_we_get_improvements/ Master Your PoE 2 Stash: Efficient Tools, Tabs, and Affinities Explained - Dving.net, accessed on February 10, 2026, https://dving.net/guides/path-of-exile-2-guides/stash-tabs-explained PoE 2 Stash Tabs Explained - Mobalytics, accessed on February 10, 2026, https://mobalytics.gg/poe-2/guides/stash-tabs Can someone explain to me, as a complete layman, what stash tabs are? : r/PathOfExile2, accessed on February 10, 2026, https://www.reddit.com/r/PathOfExile2/comments/1p1ttes/can_someone_explain_to_me_as_a_complete_layman/ an interesting discussion on Stash, Inventory, and management - Forum - Path of Exile, accessed on February 10, 2026, https://www.pathofexile.com/forum/view-thread/3878069 Stash tabs and stuff :: Path of Exile 2 General Discussions - Steam Community, accessed on February 10, 2026, https://steamcommunity.com/app/2694490/discussions/0/594008672803237534/ Early Access Feedback - Console - Stash and inventory interaction - Forum - Path of Exile, accessed on February 10, 2026, https://www.pathofexile.com/forum/view-thread/3623519 Help with grid inventory - Scripting Support - Developer Forum | Roblox, accessed on February 10, 2026, https://devforum.roblox.com/t/help-with-grid-inventory/4013605 Drag doesn't follow mouse after resizing inventory grid : r/unity - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/unity/comments/1fqayie/drag_doesnt_follow_mouse_after_resizing_inventory/ QoL suggestion: Ability to swap position of 2 items of same size in your character inventory : r/EscapefromTarkov - Reddit, accessed on February 10, 2026, https://www.reddit.com/r/EscapefromTarkov/comments/ebbo8r/qol_suggestion_ability_to_swap_position_of_2/ Cannot Quick Transfer ALL Stacks of Currency Items with CTRL+Right Click - Forum, accessed on February 10, 2026, https://www.pathofexile.com/forum/view-thread/3694358