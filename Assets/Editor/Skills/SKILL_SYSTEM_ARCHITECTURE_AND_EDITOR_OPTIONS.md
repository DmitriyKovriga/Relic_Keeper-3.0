# Система скиллов: архитектура и варианты редактора

## 1. Текущая архитектура (кратко)

| Слой | Что есть | Роль |
|------|----------|------|
| **Данные** | `SkillDataSO` | ID, имя, кулдаун, мана, иконка, ссылка на префаб, триггер анимации. |
| **Пул** | `SkillPoolSO` | Список скиллов с весами, `GetRandomSkill()`. К любому предмету можно привязать любой пул. |
| **Предметы** | `EquipmentItemSO.SkillPool`, `WeaponItemSO.SecondarySkillPool` | При генерации предмета из пула роллится скилл → попадает в `InventoryItem.GrantedSkills`. |
| **Рантайм** | `PlayerSkillManager` | По экипировке инстанцирует префаб скилла, дергает `SkillBehaviour.TryCast()`. |
| **Логика скилла** | Префаб + `SkillBehaviour` (напр. `CleaveSkill`) | Один класс на префабе оркестрирует фазы и вызывает модули. |
| **Модули** | `SkillHitbox`, `SkillDamageDealer`, `SkillVFX`, `SkillMovementControl`, `SkillHandAnimation` | Переиспользуемые компоненты: хитбокс, урон, VFX, блок движения, анимация руки. |

**Плюс архитектуры:** скилл не привязан к типу предмета. Пул формируется свободно (оружие/броня/слот), один и тот же скилл может выпадать на разных предметах. Это уже достигнуто и менять не обязательно.

**Где неудобно поддерживать и развивать:**

- **Новый скилл = код или ручная сборка префаба.** Либо новый класс, наследник `SkillBehaviour` (напр. ещё один “Cleave-like”), либо копирование префаба Cleave и подмена модулей/параметров. Нет одного “рецепта скилла” в виде данных.
- **Оркестрация зашита в код.** Последовательность фаз (windup → impact → recovery), тайминг (lock/unlock), вызовы модулей — всё в `CleaveSkill.SkillPipeline()`. Чтобы изменить поведение, нужно менять C# или плодить варианты префабов.
- **Параметры размазаны.** Тайминги — в `CleaveSkill`, множитель урона — в `SkillDamageDealer`, длительность VFX — в `SkillVFX`, радиус — в `CircleHitbox`. Нет единого места “рецепт этого скилла”.
- **Нет единого редактора.** Редактирование = префаб + несколько компонентов в Inspector. Сложно видеть “что делает скилл в целом” и как он меняется от настроек.

Итого: связка “предмет ↔ пул ↔ скилл” и модули — удачные; слабое место — **создание и изменение скилла** (всё завязано на код и ручную сборку префаба).

---

## 2. Идея: скилл из “методов” и визуальный редактор

Ты описываешь:

- большой каталог **методов** (действий);
- **визуальное программирование**: собрать скилл из комбинаций методов;
- **предпросмотр**: как поведение меняется в зависимости от того, что навешано.

По сути это **граф узлов** (ноды = методы/действия), где:

- ноды: например “PhaseWindup(0.35)”, “LockMovement”, “GetTargets(Hitbox)”, “DealDamage”, “PlayVFX”, “UnlockMovement”, “PhaseRecovery” и т.д.;
- рёбра задают порядок (и при желании ветвление);
- рантайм либо **интерпретирует** граф (данные → выполнение по шагам), либо **генерирует код** под этот граф.

Тогда “создать новый скилл” = нарисовать граф в редакторе и сохранить его как данные, без нового C# под каждый скилл.

---

## 3. Оценка объёма и сложности

### 3.1 Полноценный визуальный редактор (ноды + предпросмотр)

| Блок | Что нужно | Сложность |
|------|-----------|-----------|
| **Модель графа** | Ноды (тип, параметры, порты), связи, сериализация (ScriptableObject/JSON). | Средняя |
| **UI редактора** | Окно с канвасом, рисование нод, связи, контекстное меню, палитра методов. | Высокая |
| **Каталог “методов”** | Каждый метод = тип ноды с параметрами (float, ссылка на префаб, enum и т.д.). 10–30+ нод для начала. | Средняя |
| **Рантайм** | Интерпретатор графа (по шагам/корутинам) или кодогенерация. Учесть статы, контекст (игрок, цель, время). | Высокая |
| **Предпросмотр** | Либо Play Mode + вызов скилла, либо симуляция таймлайна в редакторе (фейковый контекст, без реального боя). | Средняя–высокая |

**Итого:** это **амбициозный** объём: по сути свой мини–Blueprint для скиллов. Оценка по времени — **недели до нескольких месяцев** в зависимости от глубины предпросмотра и количества нод.

### 3.2 Насколько это необходимо сейчас

- Сейчас у тебя по факту **один тип потока**: melee slash (windup → impact → recovery), один класс `CleaveSkill` и набор модулей.
- Визуальный граф даёт максимальную гибкость (разные порядки фаз, ветвления, многотиповые скиллы), но эта гибкость нужна только если планируется **много принципиально разных скиллов** (каналы, снаряды, мульти-хиты, комбо и т.д.).
- Если большинство скиллов — вариации “удар с разным хитбоксом/VFX/уроном”, то **данных и шаблонов может хватить без визуального графа**.

---

## 4. Альтернативы (от простой к сложной)

### 4.1 Skill Template / Recipe (рекомендуемый первый шаг)

**Идея:** один скилл = один asset “рецепт”, без нового C# и без визуального графа.

- **SkillRecipeSO** (или расширение `SkillDataSO`):
  - тип пайплайна: например `MeleeSlash`, позже `Projectile`, `Channel`;
  - таймлайн: windup%, impact%, recovery%, lock/unlock моменты;
  - конфиг модулей: тип хитбокса (Circle/Cone/…) + радиус/угол, множитель урона, ссылка на VFX-префаб, длительность VFX и т.д.
- Один **универсальный** `SkillBehaviour` (напр. `TemplatedSkill`), который читает рецепт и выполняет тот же поток, что и Cleave, но с параметрами из SO.
- **Редактор:** кастомный Inspector или отдельное окно (списки, слайдеры, ссылки на префабы). Без нод.

**Плюсы:** создание нового скилла = новый asset, ноль кода; один источник правды (рецепт); поддержка и баланс проще.  
**Минусы:** новые “сценарии” (снаряд, канал) = новый тип пайплайна в коде (но реже, чем новый класс под каждый скилл).  
**Оценка:** средняя сложность, относительно быстрый выход в использование.

### 4.2 Последовательность шагов (Step list)

**Идея:** скилл = упорядоченный список шагов. Каждый шаг — тип (Wait, LockMovement, GetTargets, DealDamage, PlayVFX, UnlockMovement, …) + параметры. Ветвлений нет, только линейная последовательность.

- Рантайм просто идёт по списку и выполняет шаги (с поддержкой ожидания по времени).
- Редактор: таблица/список шагов, добавление/удаление/сортировка, поля параметров для выбранного шага.
- Предпросмотр: Play Mode или пошаговое “проигрывание” в редакторе.

**Плюсы:** проще, чем полный граф; легко расширять новыми типами шагов; уже можно собирать скиллы без кода.  
**Минусы:** нет ветвлений (если понадобятся — шаги типа “IfHasTarget” и т.п. или переход к графу).  
**Оценка:** средняя сложность, меньше, чем полный нодовый редактор.

### 4.3 Визуальный граф (ноды + методы)

То, что ты описал: палитра методов, граф, предпросмотр.

- Максимальная гибкость и расширяемость.
- Максимальные затраты: UI графа, сериализация, интерпретатор/кодоген, предпросмотр.
- Имеет смысл вводить, когда шаблонов и step list уже не хватает (много разных сценариев скиллов, дизайнеры хотят сами собирать сложные потоки).

### 4.4 Гибрид

- Сначала внедрить **Skill Template / Recipe** и один общий рантайм под него — сразу упростить создание и поддержку скиллов.
- При необходимости добавить **step list** для скиллов со сложной последовательностью без ветвлений.
- Визуальный редактор графа планировать как следующий этап, когда станет ясно, что шаблонов и шагов недостаточно.

---

## 5. Итоговые выводы

| Вопрос | Ответ |
|--------|--------|
| **Ценность текущей системы** | Привязка скилла к предмету через пулы гибкая; скилл можно вешать на любой предмет. Это сохраняем. |
| **Главная боль** | Создание и редактирование скилла = код или ручная сборка префаба; нет одного “рецепта” и удобного единого редактора. |
| **Визуальный редактор из методов** | Мощно, но объёмно: граф, каталог нод, рантайм-интерпретатор/кодоген, предпросмотр. Оценка: недели–месяцы. |
| **Необходимость** | Зависит от планов: много разных сценариев скиллов и желание дать дизайнерам “собирать” скиллы без программиста — тогда да; если в основном вариации одного типа удара — сначала хватит данных и шаблонов. |
| **Практичная альтернатива** | **Skill Template / Recipe**: один asset на скилл, один общий рантайм, кастомный Inspector или простое окно редактора. Новые скиллы без кода, поддержка проще. В перспективе — step list или граф, если понадобится больше гибкости. |

Рекомендация: не начинать сразу с полного визуального графа. Сначала ввести **рецепт скилла (Skill Template/Recipe)** и один **TemplatedSkill** рантайм — это уже сильно упростит создание и развитие скиллов. Затем, опираясь на реальные запросы (снаряды, каналы, комбо), решить: расширять шаблоны, добавить step list или закладывать нодовый редактор.
