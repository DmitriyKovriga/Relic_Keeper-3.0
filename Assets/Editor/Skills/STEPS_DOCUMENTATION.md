# Документация по степам скиллов

## Обзор системы

Скилл может выполняться по **рецепту** — списку **степов**. Каждый степ имеет **тип** (одно общее определение на проект) и **оверрайды** параметров в конкретном скилле. Копий определений степов не создаётся.

| Сущность | Назначение |
|----------|------------|
| **StepDefinitionSO** | Один asset на тип степа (MovementLock, SpawnVFX, DealDamageCircle и т.д.). Содержит Id, отображаемые имена EN/RU (только для редактора), дефолтные параметры. |
| **StepEntry** | Запись в рецепте: ссылка на StepDefinitionSO, оверрайды, **StartPercentPipeline** и **EndPercentPipeline** (0–1) — момент начала и конца степа в пайплайне. Для мгновенных степов Start = End. Для ParallelGroup — вложенный список SubSteps. |
| **SkillRecipeSO** | Список степов (порядок только для отображения в редакторе), опционально ченнелинг (IsChanneling, ChannelLoopStepIndices, ChannelMaxDuration, ChannelTickDuration). |
| **SkillDataSO** | Данные скилла (ID, имя, иконка, кулдаун, мана). Поле **Recipe** — ссылка на SkillRecipeSO. Если Recipe задан, на префабе должен быть **SkillStepRunner** вместо классического SkillBehaviour. |

Общая длительность пайплайна (**TotalDuration**) считается в начале каста (например `1 / AttackSpeed` для атак). Время пайплайна **T** идёт от 0 до 1. Каждый степ задаёт **Start %** и **End %** пайплайна: мгновенные степы (Strike, SpawnVFX, DealDamage) имеют Start = End и выполняются в один момент; степы с диапазоном (MovementLock, WeaponWindup, WeaponRecovery, Wait) активны от Start до End (например Lock: в Start — блок, в End — разблок).

---

## Как это работает вместе

1. **Предмет** даёт скилл через пул (SkillPoolSO); при экипировке **PlayerSkillManager** инстанцирует префаб скилла и вызывает **Initialize(stats, data)**.
2. При касте вызывается **TryCast()** у SkillBehaviour. У **SkillStepRunner** запускается корутина: время **T** = elapsed / TotalDuration идёт от 0 до 1; на каждом кадре проверяются все степы — кто должен **начаться** (T ≥ Start), **обновляться** (Windup/Recovery/Wait — фаза 0..1 внутри диапазона), **закончиться** (T ≥ End, для MovementLock — разблок).
3. **Порядок степов в списке не влияет на выполнение** — только на то, в каком порядке они отображаются в редакторе. Момент выполнения задаётся только **Start %** и **End %**.
4. **MovementLock** — один степ с диапазоном: в момент Start % движение блокируется, в момент End % — разблокируется. Можно задать, например, блок с 10% по 90%.
5. **ParallelGroup** — мгновенный степ (Start = End): в этот момент пайплайна выполняются все SubSteps одновременно.
6. Если рецепт **IsChanneling**, после основного прохода по времени повторяется цикл по **ChannelLoopStepIndices** до истечения **ChannelMaxDuration** или отмены.
7. **Cancel()** (для будущего доджа) выставляет флаг отмены; корутина выходит и выполняется Cleanup (Unlock, сброс анимации).

---

## Редактор (Tools → Skill Editor)

- **Три колонки:** слева — список типов степов (клик = добавить степ в рецепт), центр — список степов в скилле с таймингом и кнопками ↑/↓/−, справа — **Inspector** выбранного степа.
- Переключатель **RU | EN** — отображение названий типов степов (NameEn / NameRu из StepDefinitionSO).
- Кнопка **Create default step defs** — создаёт папку и базовые StepDefinitionSO.
- Кнопка **Migrate Cleave to recipe** — создаёт рецепт Cleave, префаб с StepRunner и привязывает к скиллу Cleave.

### Инспектор степа (правая колонка)

При выборе степа в **центральном списке** справа отображается:

1. **Timing (% of pipeline)**  
   - Для степов **с диапазоном** (MovementLock, WeaponWindup, WeaponRecovery, Wait): поля **Start %** и **End %** (0–100). Момент начала и конца степа в пайплайне. У MovementLock: в Start % движение блокируется, в End % — разблокируется.  
   - Для **мгновенных** степов (Strike, SpawnVFX, DealDamage, MovementUnlock, ParallelGroup): одно поле **Trigger at %** — момент выполнения (0–100).  
   - В центральном списке отображается тот же тайминг: **35%** (мгновенный) или **0% – 35%** (диапазон).

2. **Step type** — popup смены типа степа (для обычного степа).

3. **Step settings** — поля, зависящие от типа:
   - **WeaponWindup / WeaponRecovery / Wait:** подсказка «Use Start % and End % in Timing section above. Duration = End − Start.»
   - **SpawnVFX:** VFX Prefab, **Scale multiplier**, Offset X/Y, Base duration (sec), Attach to parent, Invert facing.
   - **DealDamageCircle:** Radius, Source step index, Offset X/Y, Damage multiplier.
   - **DealDamageRectangle:** Size X/Y, Angle, Source step index, Damage multiplier.
   - **MovementLock / MovementUnlock / WeaponStrike:** подсказка «No extra settings».
   - **ParallelGroup:** список подстепов; клик по подстепу выделяет его, ниже — **Selected sub-step settings** (тип подстепа и его поля). Кнопки **+ Add sub-step** и **−** у каждого подстепа.

В **Step settings** (и для подстепов — в **Selected sub-step settings**) задаётся, например, какой VFX спавнить в SpawnVFX. Диапазон по времени задаётся только в блоке **Timing**.

---

## Типы степов (подробно)

Ниже каждый тип степа описан отдельным блоком: название, назначение, параметры, длительность, примеры использования.

---

### MovementLock (Блок движения)

**Назначение:** Один степ с **диапазоном** времени: в момент **Start %** пайплайна движение блокируется, в момент **End %** — разблокируется. Не нужно отдельно ставить MovementUnlock — разблок встроен в конец диапазона.

**Параметры:** Нет (только Start % и End % в блоке Timing).

**Тайминг:** Start % и End % (например 0%–100% — блок на всё время скилла; или 10%–90% — блок с 10% по 90% пайплайна).

**Когда использовать:** Чтобы игрок не мог уйти во время атаки. Задайте нужный диапазон (например 0%–100% или с небольшой задержки 5%–95%). При отмене скилла (Cancel) разблок выполняется в Cleanup.

---

### MovementUnlock (Разблок движения)

**Назначение:** Мгновенная разблокировка в заданный момент (Trigger at %). Используется, если нужно разблокировать движение в конкретный процент пайплайна отдельно от MovementLock (редкий кейс).

**Параметры:** Нет.

**Тайминг:** Один момент (Trigger at %).

**Когда использовать:** Обычно достаточно MovementLock с диапазоном (разблок в End %). MovementUnlock полезен, если разблок нужен в другой момент (например 95%) без смены End % у Lock.

---

### WeaponWindup (Замах оружия)

**Назначение:** Анимация замаха — рука/оружие из покоя переходит в положение замаха. Диапазон задаётся **Start %** и **End %** пайплайна (например 0%–35%).

**Параметры:** Нет (только Start % и End % в блоке Timing).

**Тайминг:** Start % и End % (например 0%–35%). Длительность замаха = (End − Start) × TotalDuration.

**Когда использовать:** Первая фаза удара. Задайте диапазон (например 0%–35%). В момент End % логика переходит к следующему этапу; следующий степ (Strike, VFX) обычно ставится на тот же End % или сразу после.

---

### WeaponStrike (Удар оружия)

**Назначение:** Мгновенный «кадр удара»: рука в конечной точке, оружие скрывается (чтобы не дублировать VFX). Никакой длительности — один кадр.

**Параметры:** Нет.

**Длительность:** 0%.

**Когда использовать:** Сразу после WeaponWindup, перед SpawnVFX и DealDamage. Визуально совпадает с моментом попадания.

---

### WeaponRecovery (Возврат оружия)

**Назначение:** Анимация возврата руки/оружия в покой. Диапазон задаётся **Start %** и **End %** (например 35%–100%).

**Параметры:** Нет (только Start % и End % в блоке Timing).

**Тайминг:** Start % и End % (например 35%–100%). Длительность возврата = (End − Start) × TotalDuration.

**Когда использовать:** После удара и VFX/урона. Задайте Start % = конец замаха (например 35%), End % = конец скилла (100%). Разблок движения обычно в End % того же диапазона или через MovementLock 0%–100%.

---

### Wait (Ожидание)

**Назначение:** Ничего не делает в заданном диапазоне времени. Нужен для пауз в пайплайне (задержка перед ударом, пауза между ударами в комбо).

**Параметры:** Нет (только Start % и End % в блоке Timing).

**Тайминг:** Start % и End % (диапазон паузы).

**Когда использовать:** Когда нужно вставить паузу без анимации и без блокировки движения.

---

### SpawnVFX (Спавн VFX)

**Назначение:** Спавнит один VFX-префаб в точке относительно игрока. Позиция и масштаб сохраняются в контекст и могут использоваться степом урона через **SourceStepIndex**.

**Параметры (оверрайды в рецепте):**
- **VfxPrefab** (Object) — префаб VFX. Если не задан, используется компонент SkillVFX на том же объекте (если есть).
- **ScaleMultiplier** (float) — множитель размера VFX (1 = без изменения). Удобно при переиспользовании одного префаба в разных скиллах с разным визуальным масштабом. Итоговый масштаб = AoeScale × ScaleMultiplier.
- **OffsetX**, **OffsetY** (float) — смещение от позиции игрока; OffsetX умножается на направление взгляда.
- **BaseDuration** (float) — базовая длительность жизни VFX в секундах (при скорости 1); реальная длительность масштабируется от скорости атаки.
- **AttachToParent** (bool) — привязать VFX к трансформу игрока.
- **InvertFacing** (bool) — инвертировать направление по горизонтали.

**Длительность:** 0% (спавн моментальный; длительность VFX задаётся BaseDuration).

**Когда использовать:** Для визуала удара. Если следующий степ — DealDamageCircle с **SourceStepIndex** = индекс этого степа, хитбокс возьмёт позицию и масштаб из результата SpawnVFX (совпадение с VFX).

---

### DealDamageCircle (Урон — круг)

**Назначение:** Ищет цели в круге и наносит урон по снапшоту статов (DamageCalculator). Круг можно задать вручную (радиус, offset) или привязать к позиции/масштабу степа SpawnVFX через **Source step index**.

**Параметры (оверрайды):**
- **Radius** (float) — радиус круга (по умолчанию 1.5). Масштабируется от AOE стата, если не используется SourceStepIndex; иначе от масштаба степа-источника.
- **OffsetX**, **OffsetY** (float) — смещение центра от игрока (если SourceStepIndex = −1).
- **SourceStepIndex** (int) — индекс степа в рецепте (обычно Spawn VFX), откуда брать **позицию и масштаб**. Тот степ должен выполниться раньше в том же кадре или раньше по времени (ставьте Spawn VFX выше в списке и тот же Trigger at %).
- **VfxLifetimePercent** (float, 0–1) — при Source step index ≥ 0: **момент урона в % жизненного цикла VFX**. 0 = в кадр появления VFX (как Trigger at %). 0.5 = в середине жизни VFX, 1 = в конец. Позволяет затаймить удар под нужный кадр анимации эффекта.
- **DamageMultiplier** (float) — множитель урона скилла (1 = 100% от статов).

**Момент срабатывания урона:** если **Damage at VFX life %** = 0 — в момент **Trigger at %** пайплайна. Если > 0 — в момент, когда VFX степа-источника достигнет этого % своей длительности (в секундах).

**Когда использовать:** После SpawnVFX в списке, с тем же Trigger at % и Source step index = индекс Spawn VFX. LayerMask для поиска целей задаётся на префабе скилла в **SkillStepRunner._targetLayer**.

---

### DealDamageRectangle (Урон — прямоугольник)

**Назначение:** То же, что DealDamageCircle, но зона — прямоугольник (OverlapBox). Удобно для линейных ударов.

**Параметры (оверрайды):**
- **SizeX**, **SizeY** (float) — размер бокса.
- **OffsetX**, **OffsetY** (float) — смещение центра.
- **Angle** (float) — угол поворота бокса в градусах.
- **SourceStepIndex** (int) — привязка к позиции/масштабу другого степа (обычно Spawn VFX).
- **VfxLifetimePercent** (float, 0–1) — при Source ≥ 0: момент урона в % жизни VFX (как у DealDamageCircle).
- **DamageMultiplier** (float) — множитель урона.

**Длительность:** 0%.

**Когда использовать:** Для ударов «полосой» вперёд или под углом.

---

### ParallelGroup (Параллельная группа)

**Назначение:** Выполняет несколько подстепов **одновременно** (в один кадр). Подстепы перечислены в **SubSteps**; порядок не важен для моментальных степов.

**Параметры:** Нет у самого степа; параметры задаются у каждого подстепа в SubSteps.

**Длительность:** Максимум из длительностей подстепов (если есть степы с DurationPercent).

**Когда использовать:** Два VFX в разные стороны (спереди и сзади), удар + бафф на себя, несколько зон урона в один момент.

---

## Один момент — несколько действий

Чтобы в **один момент** пайплайна выполнить несколько действий (урон, VFX, смещение), задайте этим степам **одинаковый Trigger at %** (или одинаковые Start % = End %). Порядок в списке не важен — выполнение идёт по времени. Все степы с одним и тем же моментом срабатывания выполняются в один кадр.

**Пример:** DealDamageCircle и SpawnVFX с Trigger at % = 35 — оба выполняются на 35% пайплайна одновременно.

---

## Связка Spawn VFX и урона (DealDamage + Source step index)

### Что делает Source step index

У **DealDamageCircle** и **DealDamageRectangle** есть параметр **Source step index** (индекс степа в рецепте, с 0).

- **−1 (по умолчанию):** центр и масштаб зоны урона считаются от позиции игрока и своих полей (Offset X/Y, Radius/Size). Масштаб умножается на AoeScale статов.
- **≥ 0:** центр зоны и масштаб берутся **из результата другого степа**. Обычно это степ **Spawn VFX**: при выполнении Spawn VFX он записывает в контекст позицию и масштаб эффекта; DealDamage с Source step index = индекс того степа подставляет их. Хитбокс совпадает с визуалом VFX (та же точка, тот же масштаб).

**Важно:** результат степа доступен только **после** его выполнения. Степы в одном кадре выполняются **по индексу в списке** (сначала 0, потом 1, …). Поэтому:
- Степ **Spawn VFX** должен иметь **индекс меньше**, чем степ DealDamageCircle (т.е. в редакторе расположить Spawn VFX **выше** в списке, чем урон круг).
- Оба степа должны срабатывать **в один момент** или Spawn VFX раньше по времени. Обычно ставят **одинаковый Trigger at %** (например 35%) у обоих — тогда в один кадр сначала выполнится Spawn VFX, затем DealDamage возьмёт его позицию и масштаб.

### В какой момент срабатывает урон

- **Damage at VFX life % = 0 (по умолчанию):** урон наносится в момент **Trigger at %** пайплайна (как раньше). Обычно ставят тот же Trigger at %, что и у Spawn VFX — урон в кадр появления эффекта.
- **Damage at VFX life % > 0:** урон **откладывается** до момента, когда VFX степа-источника (Source step index) проживёт эту долю своей жизни. Например 0.5 = урон в середине жизни VFX, 0.3 = в 30% жизни. Позиция и масштаб по-прежнему берутся из результата Spawn VFX (на момент спавна). Так можно затаймить удар под нужный кадр анимации эффекта, а не на первый кадр.

Поле **Damage at VFX life %** (в Step settings у DealDamageCircle/DealDamageRectangle) активно только при **Source step index ≥ 0**. Итог: **Source step index** = откуда брать позицию/масштаб; **момент урона** = либо Trigger at % пайплайна (если Damage at VFX life % = 0), либо момент, когда VFX источника достигнет заданного % своей длительности.

---

## Ченнелинг (Cyclone-стиль)

- В **SkillRecipeSO** включите **IsChanneling** и задайте **ChannelLoopStepIndices** — индексы степов из основного списка, которые повторяются в цикле.
- Эти степы **не выполняются** в основном проходе — только в цикле. Остальные степы выполняются один раз в начале.
- Цикл повторяется с шагом **ChannelTickDuration** (или TotalDuration, если 0) до истечения **ChannelMaxDuration** или отмены (Cancel).
- Проверка «кнопка зажата» пока не подключена — цикл идёт по времени/отмене.

---

## Додж и отмена

- **Додж** — отдельная механика; при появлении при активации доджа нужно вызывать **Cancel()** у текущего активного скилла.
- **SkillStepRunner.Cancel()** выставляет флаг отмены; корутина выходит и выполняется Cleanup (MovementUnlock, сброс анимации руки).

---

# Детальный план тестирования системы степов

Ниже — пошаговый сценарий проверки редактора, инспектора, уникальных настроек степов (в т.ч. VFX), отображения тайминга (0% vs Trigger at %), ParallelGroup и рантайма.

---

## 1. Редактор: открытие и структура

1. **Tools → Skill Editor** — окно открывается без ошибок.
2. Слева — список скиллов; по центру — «Steps in skill»; справа — «Inspector». Выберите скилл (например Cleave после миграции).
3. В центральном списке видны степы с подписями вида `[35%]` (мгновенный) или `[0% – 35%]` (диапазон). Тайминг задаётся в инспекторе в блоке **Timing** (Start % / End % или Trigger at %).
4. **RU | EN** — переключение меняет подписи типов степов в левой колонке и в списке степов.

---

## 2. Инспектор: где настраивать степ

1. **Выберите степ в центральном списке** (один клик по строке). Справа появится:
   - **Timing (% of pipeline)** — у степов с диапазоном (MovementLock, WeaponWindup, WeaponRecovery, Wait): поля **Start %** и **End %**. У мгновенных (Strike, SpawnVFX, DealDamage, MovementUnlock): поле **Trigger at %**.
   - **Step type** (popup).
   - **Step settings** — поля по типу (VFX Prefab, Radius и т.д.).
2. **MovementLock** — один степ с диапазоном: задайте Start % и End % (например 0% и 100%). В момент Start % движение блокируется, в момент End % — разблокируется. Можно поставить, например, 10%–90%.
3. **WeaponWindup 0–35%:** выберите степ WeaponWindup; в блоке **Timing** задайте Start % = 0, End % = 35. В центральном списке отобразится `[0% – 35%]`.

---

## 3. Уникальные настройки степов (SpawnVFX, Windup и т.д.)

1. В левой колонке нажмите **Spawn VFX** — в рецепт добавится новый степ, он выделится.
2. В **правой колонке (Inspector)** в блоке **Step settings** должны быть:
   - **VFX Prefab** — перетащите сюда префаб VFX или выберите из проекта.
   - Offset X, Offset Y, Base duration (sec), Attach to parent, Invert facing.
3. В блоке **Timing** задайте **Trigger at %** (момент спавна VFX, например 35). Задайте VFX Prefab и сохраните рецепт. В игре при касте этого скилла должен спавниться выбранный VFX в заданный момент.
4. Выберите степ **WeaponWindup**. В блоке Timing — **Start %** и **End %**. Поставьте, например, 0 и 25 — в центральном списке отобразится `[0% – 25%]`.
5. Аналогично проверьте **WeaponRecovery** и **Wait** (Start % / End %), **DealDamageCircle** (Radius, Source step index, Damage multiplier), **DealDamageRectangle** (Size X/Y, Angle и т.д.). У **MovementLock / MovementUnlock / WeaponStrike** в Step settings только подсказка «No extra settings».

---

## 4. ParallelGroup: создание и настройка подстепов

1. В **левой колонке** нажмите **ParallelGroup** (или «Параллельная группа» в RU). В рецепт добавится степ типа ParallelGroup, он выделится.
2. В **правой колонке** появится:
   - **Timing** — Trigger at % (момент выполнения группы).
   - **Sub-steps (run at same time)** — список подстепов. Изначально может быть пусто.
3. Нажмите **+ Add sub-step**. В списке появится подстеп (по умолчанию первый тип из списка). Нажмите на него — он выделится (подсветка).
4. Ниже появится блок **Selected sub-step settings**: popup **Sub-step type** и поля по типу. Выберите тип **Spawn VFX**, в **VFX Prefab** укажите первый префаб (например VFX_A). При необходимости задайте Offset X (например −1).
5. Снова **+ Add sub-step**. Выберите второй подстеп в списке, тип **Spawn VFX**, другой префаб или другой Offset X (например 1), чтобы два VFX отличались.
6. Сохраните рецепт. **Ожидаемое поведение в игре:** при выполнении этого степа ParallelGroup оба VFX появляются **в один кадр** (одновременно). Проверка: запустить скилл, убедиться, что оба эффекта видны в один момент (или добавить временный Debug.Log в SkillStepRunner в месте выполнения группы с временем кадра).
7. Удаление подстепа: кнопка **−** справа от подстепа в списке. Смена типа подстепа: выделить подстеп → в **Sub-step type** выбрать другой тип → в Step settings появятся поля нового типа.

---

## 5. Чеклист по разделам

### Редактор и данные

- [ ] Tools → Skill Editor открывается без ошибок.
- [ ] Три колонки: скиллы/типы степов | степы в скилле | инспектор выбранного степа.
- [ ] RU | EN переключает подписи типов степов.
- [ ] Create default step defs создаёт Step_*.asset; после Refresh типы видны слева.
- [ ] Добавление степа: клик по типу слева. Удаление: кнопка − в центральном списке. Перемещение: ↑/↓.
- [ ] В центральном списке тайминг: `[35%]` (мгновенный) или `[0% – 35%]` (диапазон) — задаётся в блоке Timing инспектора (Start % / End % или Trigger at %).
- [ ] Migrate Cleave to recipe создаёт Recipe_Cleave и префаб с StepRunner; в рецепте 7 степов (Lock 0–100%, Windup 0–35%, Strike 35%, SpawnVFX 35%, DealDamage 35%, Recovery 35–100%, Unlock 100%).

### Инспектор и настройки степов

- [ ] Выбор степа в центральном списке показывает справа: **Timing** (% of pipeline), Step type, Step settings.
- [ ] WeaponWindup / WeaponRecovery / Wait: в блоке Timing — **Start %** и **End %**; в Step settings — подсказка про Timing. Диапазон в списке совпадает с Start % – End %.
- [ ] SpawnVFX: в Step settings есть **VFX Prefab**, Offset X/Y, Base duration, Attach to parent, Invert facing. Назначенный префаб спавнится в игре.
- [ ] DealDamageCircle/Rectangle: Radius (или Size), Source step index, Damage multiplier и т.д. редактируются и работают в игре.
- [ ] MovementLock / MovementUnlock / WeaponStrike: в Step settings отображается «No extra settings».

### ParallelGroup

- [ ] Добавление ParallelGroup из левой колонки создаёт степ с пустым списком подстепов.
- [ ] + Add sub-step добавляет подстеп; клик по подстепу выделяет его и показывает **Selected sub-step settings** (тип + поля).
- [ ] У подстепа можно задать тип (Spawn VFX, DealDamage и т.д.) и все поля (VFX Prefab и т.д.).
- [ ] В игре группа с двумя SpawnVFX (разные префабы или Offset): оба VFX в один кадр.

### Игра: Cleave по рецепту

- [ ] Cleave привязан к Recipe и префабу с SkillStepRunner.
- [ ] Замах → удар → VFX → урон → возврат; движение блокируется и разблокируется.
- [ ] VFX и урон в правильной позиции; при изменении AttackSpeed длительность масштабируется.

### Отложенные триггеры, ченнелинг, отмена, граничные случаи

- [ ] Степы с одинаковым Trigger at % (или одинаковым Start % = End %) срабатывают в один момент пайплайна.
- [ ] IsChanneling + ChannelLoopStepIndices: цикл повторяется до ChannelMaxDuration/отмены.
- [ ] Cancel() прерывает скилл, разблокирует движение, сбрасывает анимацию.
- [ ] Пустой рецепт / Recipe == null / StepDefinition == null / неверный SourceStepIndex не вызывают падения.

После прохождения чеклиста систему степов можно считать готовой к использованию и к привязке доджа к Cancel().

**Важно:** Рецепты, сохранённые до перехода на модель «Start % / End %», после обновления будут иметь Start/End = 0. Нужно заново задать тайминг в инспекторе (Start %, End %, Trigger at %) или заново выполнить **Migrate Cleave to recipe** для Cleave.
