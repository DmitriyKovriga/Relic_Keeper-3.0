# План: крафт и сферы (Crafting Orbs)

## 1. Общая картина

- **Вкладка справа** в окне инвентаря переключает вид: **Экипировка** | **Крафт**.
- В режиме **Крафт**: сверху один слот (любой предмет), под ним — фиксированные слоты сферами (как в PoE), под ними — сетка инвентаря.
- **Одна сфера** на старте: иконка + количество в своей ячейке; пустая ячейка — без спрайта и числа.
- **Применение сферы**: ПКМ по сфере → «режим применения» (подсветка сферы + спрайт на курсоре), затем ЛКМ по редкому предмету в верхнем слоте → предмет перезаральивается (новый набор аффиксов). ESC / ЛКМ мимо — отмена.

---

## 2. To-Do (порядок работ)

### Фаза A: Данные и эффекты ✅ (сделано)

- [x] **A1. CraftingOrbSO**  
  ScriptableObject сферы: `Sprite Icon`, `string NameKey`, `string DescriptionKey` (ключи локали), `string EffectId` (или enum/ссылка на тип эффекта). Опционально: `int Order` для сортировки в редакторе.

- [x] **A2. Тип эффекта «Reroll Rare»**  
  Определить, как эффект задаётся: по `EffectId` строка (например `"reroll_rare"`) или enum `CraftingOrbEffectType`. В коде применения — проверка: если сфера с эффектом reroll_rare, то вызывать логику перезаролла.

- [x] **A3. Логика перезаролла редкого предмета**  
  Отдельный метод (в `ItemGenerator` или в новом `CraftingService`): на входе `InventoryItem` (редкий), на выходе — тот же предмет с очищенными и заново сгенерированными аффиксами (редкость 2, тот же уровень/база). Редкость = 2 если `Affixes.Count >= 3` (или по своей формуле).

- [x] **A4. Хранение количества сфер у игрока**  
  Структура данных: например `Dictionary<string, int>` по ID сферы (или `List<CraftingOrbStack>`). Сохранение/загрузка в сейв. Где хранить: отдельный `CraftingOrbInventory` / компонент на гейм-менеджере или расширение `InventoryManager`.

### Фаза B: UI инвентаря — вкладка и вид «Крафт» ✅ (сделано)

- [x] **B1. Вкладка переключения**  
  Справа в окне инвентаря (в UXML) два таба/кнопки: «Экипировка», «Крафт». По клику переключается контент (два контейнера: один с куклой экипировки, другой с одним слотом + зона сфер).

- [x] **B2. Вид «Крафт»**  
  Вместо куклы экипировки: один слот (любой предмет). Под ним горизонтальная полоса фиксированных слотов сфер (пока 1 слот под одну сферу). Под ней — та же сетка инвентаря, что и в режиме экипировки.

- [x] **B3. Отображение сферы в ячейке**  
  Один слот = фиксированный тип сферы (CraftingOrbSO), количество берётся из хранилища. Если количество 0: пустая ячейка (без спрайта и текста). Если > 0: иконка сферы + Label с числом (например «5»). Стили под общий стиль инвентаря.

- [x] **B4. Интеграция с InventoryUI и сохранение слота крафта**  
  При переключении вкладки обновлять видимость блоков и источник данных для верхней части (экипировка vs один слот крафта). **Предмет в слоте крафта сохранять как в инвентаре** — отдельный слот в данных (например в InventoryManager или CraftingState), сохранение/загрузка в сейв вместе с инвентарём.

### Фаза C: Применение сферы (ПКМ → курсор → ЛКМ по предмету) ✅ (сделано)

- [x] **C1. ПКМ по слоту сферы**  
  Обработчик контекстного клика: если сфера есть (количество > 0) и предмет подходит под эффект (для reroll — не требуется предмет заранее), войти в режим «применения сферы»: запомнить тип сферы, подсветить слот сферы, показать «призрак» иконки сферы на курсоре (аналогично перетаскиванию предмета).

- [x] **C2. Отмена: ESC, ЛКМ не по целевому предмету**  
  При ESC или ЛКМ по пустому месту / не по редкому предмету в верхнем слоте — сброс режима (убрать подсветку и призрак с курсора).

- [x] **C3. ЛКМ по редкому предмету в верхнем слоте крафта**  
  Если активен режим применения сферы с эффектом «reroll_rare» и под курсором редкий предмет в слоте крафта: списать одну сферу, вызвать перезаролл предмета, обновить UI, выйти из режима применения.

- [x] **C4. Редкость предмета**  
  В коде: считать предмет редким, если у него достаточно аффиксов (например >= 3). Вынести в один метод `IsRare(InventoryItem)` для использования в UI и при применении сферы.

### Фаза D: Локализация сфер ✅ (сделано)

- [x] **D1. Таблица локали для сфер**  
  В коде используется таблица **MenuLabels**: ключи берутся из `CraftingOrbSO.NameKey` / `DescriptionKey` или по умолчанию `crafting_orb.{orbId}.name` и `crafting_orb.{orbId}.description`. Записи en/ru нужно добавить в MenuLabels (или позже в редакторе E3 — Sync).

- [x] **D2. Отображение имени/описания в игре**  
  При наведении на слот сферы показывается тултип (ItemTooltipController.ShowOrbTooltip) с локализованными именем и описанием.

### Фаза E: Crafting Orb Editor (Editor Window) ✅ (сделано)

- [x] **E1. Окно редактора**  
  `Tools/RPG/Crafting Orb Editor`: список всех CraftingOrbSO (поиск по всем ассетам), иконка + имя + EffectId. Блок назначения слотов ниже.

- [x] **E2. Редактирование**  
  Выбор сферы → справа инспектор (SerializedObject): ID, Icon, NameKey, DescriptionKey, EffectId. Кнопки «Open in Inspector», «Delete orb».

- [x] **E3. Локали**  
  Поле MenuLabels String Table Collection; кнопки «Sync / Create keys for selected orb» и «Sync / Create keys for ALL orbs» — добавление/обновление записей en/ru по NameKey и DescriptionKey.

- [x] **E4. Создание и удаление**  
  «Create New Orb» — новый CraftingOrbSO в `Resources/CraftingOrbs/` (папка создаётся при необходимости). «Delete orb» — с подтверждением, сфера убирается из конфига слотов.

- [x] **E5. Назначение слотов и визуализация**  
  Конфиг (CraftingOrbSlotsConfigSO): поле «Slots config», кнопка «Create config» (создаёт `Resources/CraftingOrbs/CraftingOrbSlotsConfig.asset`). Slot count 1–12, для каждого слота — выпадающий список (Empty + все сферы) и кнопка «Clear». **Логика**: при выборе сферы A в слот, где уже B — если A уже в другом слоте, делается swap A↔B; иначе B освобождается, в слот ставится A. В лог пишется сообщение (Swap / cleared).

- [x] **E6. Сохранение конфига**  
  Конфиг сохраняется в ассет; кнопка «Save config» вызывает AssetDatabase.SaveAssets(). SetDirty при изменении слотов.

---

## 3. Решённые вопросы

1. **Слот крафта (предмет сверху)** — сохранять как в инвентаре: отдельный слот в данных, сейв/загрузка вместе с инвентарём.
2. **EffectId** — оставляем строку (например `"reroll_rare"`) + в коде `switch` или словарь обработчиков; при желании позже можно вынести константы/enum.
3. **Папка ассетов сфер** — `Resources/CraftingOrbs/`.
4. **Первая сфера** — одна «Reroll Rare» (аналог Chaos Orb), один слот в игре; в редакторе — полный инструментал назначения слотов и визуализация (E5–E6).

---

## 4. Логика «орба в занятый слот» (резюме для редактора)

- **Модель**: фиксированное число слотов (например 6). Каждый слот либо пустой, либо в нём ровно одна сфера. Одна и та же сфера не может быть в двух слотах.
- **Действие**: «поставить сферу A в слот S».
  - Если S пустой → назначаем A в S.
  - Если в S уже сфера B:
    - **Swap**: если A уже была назначена в слот T, то меняем местами: после действия в S будет A, в T будет B.
    - Если A нигде не была назначена: тогда B освобождается (убирается из S), в S ставится A. Либо B переносится в первый свободный слот — на выбор; в плане заложен вариант «B освобождается» для простоты.
- **UI**: в редакторе всегда видно заполненные и пустые слоты; при действии с занятым слотом показывать превью (обмен / перенос) и применять по подтверждению или сразу с явным сообщением.

---

## 5. Ссылки на существующий код

- Локализация: `LocalizationSettings.StringDatabase.GetLocalizedStringAsync(table, key)`, StringTable в `Assets/Localization/LocalizationTables/`.
- Генерация аффиксов: `ItemGenerator.Generate(baseItem, itemLevel, rarity)`, пулы в `AffixPoolSO`, слот/тип брони для выбора пула.
- Инвентарь UI: `Assets/UI/Inventory/InventoryLayout.uxml`, `InventoryUI.cs`, слоты через класс `slot`.
- Редакторы: пример структуры — `Assets/Editor/Stats/StatsEditorWindow.cs`, `Assets/Editor/Items/ItemsEditorWindow.cs`.

Если что-то из плана поменять (например, при занятом слоте всегда переносить B в первый свободный вместо swap) — напиши, скорректируем.
