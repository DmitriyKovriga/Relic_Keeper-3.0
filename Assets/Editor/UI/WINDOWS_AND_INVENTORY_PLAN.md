# План: система окон и доработка инвентаря (Path of Exile–стиль)

## 1. Текущая архитектура (кратко)

### 1.1 Окна

| Компонент | Назначение |
|-----------|------------|
| **WindowManager** | Стек окон. `OpenWindow(w)` — закрывает текущее верхнее окно (если другое), пушит новое, показывает. `CloseTop()` — снимает верхнее и скрывает. При первом открытии отключает Player input, при последнем закрытии — включает. |
| **WindowView** | Ищет в своём UIDocument корень `WindowRoot`, опционально `Overlay`. По Open/Close переключает `display` корня. Клик по Overlay вызывает Close. |
| **Toggle-скрипты** | InventoryWindowToggle, CharacterWindowToggle, PassiveTreeWindowToggle, PauseMenuToggle — вешают ввод (или Update) и вызывают Open/Toggle. |

- **Пассивное дерево:** toggle реализован: если `TopWindow == _skillTreeWindow` → CloseTop, иначе OpenWindow.
- **Инвентарь и персонаж:** только OpenWindow (без проверки «уже открыто»), т.е. **повторное нажатие той же кнопки не закрывает** окно.
- **ESC:** обрабатывается в PauseMenuToggle (Update): если есть открытые окна — CloseTop, иначе открывается Pause Menu.

### 1.2 Инвентарь (UXML + USS)

- **WindowRoot** = весь экран: `width/height 100%`, фон `.window-container` — **rgba(8,8,8,0.98)** (почти непрозрачный чёрный) → **полное затемнение фона**.
- **Структура:** слева пустая колонка (col-stats), по центру **Equipment** (кукла: Head, Body, Main, Off, Hand, Feet), справа **Backpack** (сетка). Overlay в конце (в USS `display: none` — не рисуется, затемнение даёт сам контейнер).
- **Слоты экипировки:** слева/по центру, в виде «куклы»; инвентарь справа. В POE, наоборот, сетка инвентаря слева/по центру, экипировка **справа над/рядом с сеткой**, компактно.
- Одно окно занимает весь экран; при открытии другого текущее **закрывается** — нельзя держать инвентарь + склад или инвентарь поверх дерева.

---

## 2. Проблемы

### 2.1 Система окон

1. **Одно окно за раз** — при открытии инвентаря закрывается дерево (и наоборот). Нет режима «инвентарь + склад» или «инвентарь на фоне дерева».
2. **Инвентарь не закрывается по своей кнопке** — только по ESC или (если бы был) клику по overlay. Нет единого правила «открыл по бинду — закрыл по тому же бинду».
3. **Нет единого места для ESC** — логика в PauseMenuToggle; удобнее иметь один обработчик «закрыть верхнее окно» и при необходимости открыть паузу.
4. **Нет закрытия конкретного окна** — только CloseTop. Для нескольких открытых окон нужен метод «закрыть это окно» (по бинду или кнопке).

### 2.2 Инвентарь (внешний вид и UX)

5. **Полное затемнение** — `.window-container` на весь экран с почти непрозрачным фоном. Нужно: либо панель не на весь экран, либо полупрозрачный/без фона, чтобы был виден мир (как в POE).
6. **Расположение экипировки** — сейчас слева от инвентаря. Нужно: экипировка **справа над слотами инвентаря** (или справа от сетки), компактный блок.
7. **Компактность** — слоты и блок в целом сдвинуть вниз, уменьшить «воздух», чтобы панель занимала меньше места и не перекрывала весь экран.

---

## 3. Решения

### 3.1 Унифицированная система окон

| Задача | Решение |
|--------|--------|
| Несколько окон одновременно | В `WindowManager.OpenWindow(w)` **не** закрывать текущее окно; только добавить в стек и показать окно. При закрытии — убирать только то окно, которое закрыли. |
| Закрытие по той же кнопке | Во всех Toggle (Inventory, Character, PassiveTree): если `менеджер.ОкноОткрыто(это окно)` → вызвать `CloseWindow(это окно)`, иначе `OpenWindow(это окно)`. Для этого в WindowManager добавить: `bool IsOpen(WindowView w)`, `void CloseWindow(WindowView w)` (удалить из стека, вызвать CloseInternal, при необходимости обновить порядок отрисовки). |
| ESC закрывает верхнее | Оставить централизованно: один компонент (например тот же PauseMenuToggle или отдельный EscapeHandler) по ESC вызывает `CloseTop()`; если окон не осталось — при желании открывать паузу. |
| Порядок окон | Стек: последнее открытое = «сверху». При отрисовке несколько UIDocument могут быть видны сразу; порядок сортировки панелей задать по стеку (если Unity это позволяет) или оставить дефолтный. |

### 3.2 Внешний вид инвентаря (POE-стиль)

| Задача | Решение |
|--------|--------|
| Размер блока инвентаря | **До 50% экрана** (по ширине). Панель инвентаря занимает правую половину (или до 50% ширины), левая половина остаётся свободной под **склад** или другое окно — как в Path of Exile (два окна рядом: инвентарь справа, склад слева). Не затемнять весь экран: фон только у самой панели слотов (или полупрозрачный), мир/другие окна видны. |
| Экипировка справа над инвентарём | Внутри своей 50%-панели: сначала сетка рюкзака, справа (или сверху справа) — блок экипировки. Итог: компактный блок «сетка + экипировка» в правой половине экрана. |
| Компактность | Уменьшить отступы, сдвинуть слоты вниз; блок не на весь экран по высоте — компактно. |

### 3.3 Детали реализации

- **WindowManager:**  
  - `bool IsOpen(WindowView w)` — есть ли окно в стеке.  
  - `void CloseWindow(WindowView w)` — удалить `w` из стека, вызвать `w.CloseInternal()`.  
  - `OpenWindow(w)` — если уже в стеке, опционально «вынести вверх» (удалить из стека и снова push). Иначе просто push и OpenInternal.

- **Toggle-скрипты:**  
  - Единый шаблон: по нажатию бинда вызывать `if (manager.IsOpen(myWindow)) manager.CloseWindow(myWindow); else manager.OpenWindow(myWindow);`.

- **Инвентарь (UXML/USS):**  
  - Новая раскладка: контейнер панели (не 100% экрана) — например `align-self: flex-end`, `right: 0`, `bottom: 0`, фиксированная ширина. Внутри: строка или два блока — [ Backpack grid ] и [ Equipment ]. Equipment справа и/или сверху от сетки.  
  - Фон: убрать или ослабить затемнение (прозрачность или только у внутренней панели).

- **ESC:**  
  - Один раз обрабатывать в Update или через Input System; вызывать `WindowManager.CloseTop()`; если окон нет — открывать Pause (как сейчас).

---

## 4. Этапы реализации

### Фаза 1: Логика окон (WindowManager + Toggle)

1. Добавить в **WindowManager**: `IsOpen(WindowView w)`, `CloseWindow(WindowView w)` (удаление из стека + CloseInternal).
2. Изменить **OpenWindow**: не вызывать CloseTop при открытии другого окна; при открытии уже открытого — опционально вынести в верх стека (удалить, push).
3. Во всех **InventoryWindowToggle**, **CharacterWindowToggle** (и при необходимости PassiveTreeWindowToggle) использовать логику: по бинду — если IsOpen(this) → CloseWindow(this), иначе OpenWindow(this).
4. Убедиться, что **ESC** по-прежнему закрывает верхнее окно (PauseMenuToggle или общий обработчик).

**Результат:** несколько окон могут быть открыты сразу; каждое закрывается своей кнопкой и по ESC (верхнее).

---

### Фаза 2: Инвентарь — без полного затемнения

5. Изменить разметку/стили инвентаря: панель занимает **до 50% ширины экрана** (правая половина), чтобы слева оставалось место под склад/другое окно (POE-стиль).
6. Убрать полное затемнение: контейнер не на весь экран, фон только у панели слотов (или полупрозрачный).

**Результат:** инвентарь справа (до 50% экрана), слева свободно под склад; мир/другие окна видны.

---

### Фаза 3: Инвентарь — раскладка POE (экипировка справа над сеткой)

7. Переверстать **InventoryLayout.uxml**: порядок и вложенность — сначала сетка рюкзака (InventoryGrid), затем блок слотов экипировки справа и/или сверху от неё.
8. Подправить **InventoryStyles.uss**: размеры и позиции колонок/блоков так, чтобы экипировка была компактно справа над слотами инвентаря.
9. В **InventoryUI** при необходимости скорректировать имена/контейнеры (Slot_Helmet и т.д.) под новую разметку; логика слотов и drag-drop остаётся.

**Результат:** расположение как в POE, компактный блок.

---

### Фаза 4: Компактность и полировка

10. Уменьшить отступы, сдвинуть блок слотов вниз, поджать заголовки и размеры.
11. Проверить работу с несколькими окнами (инвентарь + персонаж, инвентарь + дерево), ESC и бинды.

---

## 5. Итог

- **Окна:** единая логика — несколько окон одновременно, закрытие по своей кнопке и по ESC, методы IsOpen/CloseWindow в WindowManager.
- **Инвентарь:** блок до 50% экрана (правая половина), слева место под склад/другое окно; без полного затемнения; экипировка справа над слотами инвентаря внутри панели, компактно.

После согласования плана можно переходить к реализации по фазам.
